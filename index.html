<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piel Telecom - Qualificador de Leads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/styles.css">
</head>
<body class="bg-gray-100">

    <div id="auth-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-8">
                    <i class="fas fa-headset text-5xl text-blue-600"></i>
                    <h1 class="text-3xl font-bold text-gray-800 mt-4">Piel Telecom</h1>
                    <p class="text-gray-600">Qualificador de Leads</p>
                </div>
                
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="E-mail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Entrar</button>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <input type="text" id="register-name" placeholder="Nome do Vendedor" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <input type="email" id="register-email" placeholder="E-mail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                    <p id="register-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Cadastrar</button>
                </form>
                
                <div class="relative flex py-3 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-sm">OU</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <button type="button" id="google-login-btn" class="w-full flex justify-center items-center gap-2 bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50">
                    <img class="w-5 h-5" src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google logo">
                    Entrar com o Google
                </button>

                <div class="text-center mt-4">
                    <a href="#" id="toggle-form" class="text-sm text-blue-600 hover:underline">Não tem uma conta? Cadastre-se</a>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden w-full max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-4 sm:p-6 md:p-8 my-4 sm:my-8">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div class="text-center md:text-left">
                 <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-800">Painel de Qualificação de Leads</h1>
                 <div id="user-info" class="text-sm text-gray-500"></div>
            </div>
            <div class="flex flex-wrap justify-center md:justify-end gap-2">
                <a href="./dashboard.html" id="dashboard-link" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 flex items-center hidden"><i class="fas fa-tachometer-alt mr-2"></i> Dashboard</a>
                <button id="addRowBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center"><i class="fas fa-plus mr-2"></i> Adicionar</button>
                <button id="logoutBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center"><i class="fas fa-sign-out-alt mr-2"></i> Sair</button>
            </div>
        </div>
        <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">Data de Criação</th>
                        <th class="text-left p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">Contato</th>
                        <th class="text-left p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">Fonte</th>
                        <th class="text-left p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">Qualificação</th>
                        <th class="text-left p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">CEP</th>
                        <th class="text-left p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">Observação Rápida</th>
                        <th class="text-center p-2 md:px-4 font-semibold text-xs sm:text-sm text-gray-600 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody id="leadsTableBody" class="text-gray-700"></tbody>
            </table>
        </div>
    </div>
    
    <div id="caseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 overflow-y-auto">
        <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full my-auto flex flex-col">
            <div class="flex justify-between items-center p-6 border-b sticky top-0 bg-white rounded-t-lg">
                <h2 class="text-xl font-bold text-gray-800">Formulário de Caso</h2>
                <button id="closeCaseModal" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 p-4 bg-gray-50 rounded-lg">
                    <div><label class="block text-sm font-medium text-gray-500">Contato</label><p id="caseContato" class="mt-1 text-gray-900 font-semibold"></p></div>
                    <div><label class="block text-sm font-medium text-gray-500">Vendedor(a)</label><p id="caseVendedor" class="mt-1 text-gray-900 font-semibold"></p></div>
                </div>
                
                <div><label for="caseNomeCompleto" class="block text-sm font-medium text-gray-700">Nome Completo</label><input type="text" id="caseNomeCompleto" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                
                <fieldset class="border p-4 rounded-md">
                    <legend class="text-sm font-medium text-gray-700 px-1">Endereço Completo</legend>
                    <div class="space-y-4 mt-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label for="caseRua" class="block text-sm font-medium text-gray-700">Rua</label><input type="text" id="caseRua" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                            <div><label for="caseNumero" class="block text-sm font-medium text-gray-700">Número</label><input type="text" id="caseNumero" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                            <div><label for="caseBairro" class="block text-sm font-medium text-gray-700">Bairro</label><input type="text" id="caseBairro" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                        </div>
                        <div><label for="caseCidade" class="block text-sm font-medium text-gray-700">Cidade</label><input type="text" id="caseCidade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></div>
                    </div>
                </fieldset>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="casePrazo" class="block text-sm font-medium text-gray-700">Data de Retorno</label>
                        <input type="date" id="casePrazo" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="caseUrgencia" class="block text-sm font-medium text-gray-700">Nível de Urgência</label>
                        <select id="caseUrgencia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="Baixa">Baixa</option>
                            <option value="Média" selected>Média</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                </div>

                <div><label for="caseTextArea" class="block text-sm font-medium text-gray-700">Descrição Detalhada do Caso</label><textarea id="caseTextArea" rows="6" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Descreva o que foi tratado, problemas, soluções..."></textarea></div>
            </div>
            <div class="flex justify-end gap-4 p-6 border-t sticky bottom-0 bg-white rounded-b-lg">
                <button id="cancelCaseModal" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="saveCaseBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Caso</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- 1. IMPORTAÇÕES DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import {
            getAuth, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            GoogleAuthProvider, signInWithPopup
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import {
            getFirestore, collection, doc, addDoc, setDoc, getDoc,
            updateDoc, deleteDoc, onSnapshot, query, where, orderBy,
            serverTimestamp, getDocs
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- 2. CONFIGURAÇÃO E INICIALIZAÇÃO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCTAaa5sF_O4S38FpyV_mL2hpB0xGXgAv4",
            authDomain: "qualificacao-a14ff.firebaseapp.com",
            projectId: "qualificacao-a14ff",
            storageBucket: "qualificacao-a14ff.appspot.com",
            messagingSenderId: "955642076737",
            appId: "1:955642076737:web:f6db77134cd6a18b8f30c0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // --- 3. LÓGICA PRINCIPAL DA APLICAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Variáveis de Estado ---
            let currentUserData = null;
            let leadsUnsubscribe = null;
            let qualificacoesDinamicas = [];
            let fontesDinamicas = [];
            let currentEditingDocId = null;

            // --- Elementos DOM ---
            const authScreen = document.getElementById('auth-screen');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const toggleFormLink = document.getElementById('toggle-form');
            const loginError = document.getElementById('login-error');
            const registerError = document.getElementById('register-error');
            const appScreen = document.getElementById('app');
            const userInfo = document.getElementById('user-info');
            const logoutBtn = document.getElementById('logoutBtn');
            const dashboardLink = document.getElementById('dashboard-link');
            const addRowBtn = document.getElementById('addRowBtn');
            const tableBody = document.getElementById('leadsTableBody');
            const caseModal = document.getElementById('caseModal');
            const closeCaseModalBtn = document.getElementById('closeCaseModal');
            const cancelCaseModalBtn = document.getElementById('cancelCaseModal');
            const saveCaseBtn = document.getElementById('saveCaseBtn');
            
            // --- Controlador Principal (Auth State) ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    await setupQualificador(user);
                } else {
                    appScreen.classList.add('hidden');
                    authScreen.classList.remove('hidden');
                    if (leadsUnsubscribe) leadsUnsubscribe();
                    tableBody.innerHTML = '';
                }
            });

            // --- Lógica de Autenticação ---
            loginForm.addEventListener('submit', handleEmailLogin);
            registerForm.addEventListener('submit', handleEmailRegister);
            googleLoginBtn.addEventListener('click', handleGoogleLogin);
            toggleFormLink.addEventListener('click', toggleAuthForms);
            logoutBtn.addEventListener('click', () => signOut(auth));

            async function handleEmailLogin(e) {
                e.preventDefault();
                try {
                    await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value);
                } catch (error) {
                    loginError.textContent = 'E-mail ou senha inválidos.';
                    loginError.classList.remove('hidden');
                }
            }

            async function handleEmailRegister(e) {
                e.preventDefault();
                const name = registerForm['register-name'].value;
                if (!name.trim()) {
                    registerError.textContent = 'Por favor, insira seu nome.';
                    return registerError.classList.remove('hidden');
                }
                try {
                    const cred = await createUserWithEmailAndPassword(auth, registerForm['register-email'].value, registerForm['register-password'].value);
                    await createUserProfileDocument(cred.user, { nome: name });
                } catch (error) {
                    registerError.textContent = error.code === 'auth/email-already-in-use' ? 'Este e-mail já está em uso.' : 'Ocorreu um erro ao cadastrar.';
                    registerError.classList.remove('hidden');
                }
            }

            async function handleGoogleLogin() {
                try {
                    const result = await signInWithPopup(auth, googleProvider);
                    await createUserProfileDocument(result.user);
                } catch (error) {
                    loginError.textContent = 'Não foi possível fazer login com o Google.';
                    loginError.classList.remove('hidden');
                }
            }
            
            function toggleAuthForms(e) {
                e.preventDefault();
                loginForm.classList.toggle('hidden');
                registerForm.classList.toggle('hidden');
                loginError.classList.add('hidden');
                registerError.classList.add('hidden');
                toggleFormLink.textContent = loginForm.classList.contains('hidden') ? 'Já tem uma conta? Entre' : 'Não tem uma conta? Cadastre-se';
            }

            async function createUserProfileDocument(user, additionalData = {}) {
                if (!user) return;
                const userRef = doc(db, 'users', user.uid);
                const snapshot = await getDoc(userRef);
                if (!snapshot.exists()) {
                    const { email, displayName } = user;
                    await setDoc(userRef, { email, nome: additionalData.nome || displayName || 'Usuário', role: 'user', createdAt: serverTimestamp() });
                }
            }

            // --- Lógica do Qualificador ---
            async function setupQualificador(user) {
                try {
                    const [userDoc, qualificacoesSnap, fontesSnap] = await Promise.all([
                        getDoc(doc(db, 'users', user.uid)),
                        getDocs(collection(db, 'qualificacoes')),
                        getDocs(collection(db, 'fontes'))
                    ]);

                    if (!userDoc.exists()) return signOut(auth);
                    
                    currentUserData = userDoc.data();
                    qualificacoesDinamicas = qualificacoesSnap.docs.map(d => d.data().nome).sort();
                    fontesDinamicas = fontesSnap.docs.map(d => d.data().nome).sort();
                    
                    userInfo.textContent = `Vendedor: ${currentUserData.nome} (${currentUserData.email})`;
                    dashboardLink.classList.toggle('hidden', currentUserData.role !== 'admin');
                    
                    listenToLeads(user.uid);
                } catch (error) {
                    console.error("Erro ao configurar o qualificador:", error);
                    signOut(auth);
                }
            }

            addRowBtn.addEventListener('click', handleAddNewLead);
            
            // ATUALIZAÇÃO AQUI: Evento trocado de 'input' para 'change' para corrigir o problema de digitação.
            tableBody.addEventListener('change', e => {
                if (e.target.matches('input, select')) {
                    const tr = e.target.closest('tr');
                    if (tr) updateLead(tr.dataset.id, { [e.target.dataset.field]: e.target.value });
                }
            });

            tableBody.addEventListener('click', e => {
                const removeBtn = e.target.closest('.removeRowBtn');
                const openCaseBtn = e.target.closest('.openCaseModalBtn');
                if (removeBtn && confirm('Tem certeza?')) deleteLead(removeBtn.closest('tr').dataset.id);
                if (openCaseBtn) openCaseModal(openCaseBtn.closest('tr').dataset.id);
            });

            function listenToLeads(userId) {
                if (leadsUnsubscribe) leadsUnsubscribe();
                const q = query(collection(db, 'leads'), where("userId", "==", userId), orderBy('createdAt', 'desc'));
                leadsUnsubscribe = onSnapshot(q, snap => {
                    tableBody.innerHTML = '';
                    if (snap.empty) addNewLead();
                    else snap.docs.forEach(renderLeadRow);
                });
            }

            async function handleAddNewLead() {
                const firstRow = tableBody.firstElementChild;
                if (firstRow) {
                    if (!firstRow.querySelector('[data-field="contato"]').value || !firstRow.querySelector('[data-field="qualificacao"]').value) {
                        return alert('Preencha o Contato e a Qualificação do lead atual.');
                    }
                }
                await addNewLead();
            }
            
            async function addNewLead() {
                if (!auth.currentUser || !currentUserData) return;
                await addDoc(collection(db, 'leads'), { 
                    userId: auth.currentUser.uid, vendedor: currentUserData.nome, createdAt: serverTimestamp(),
                    contato: '', fonte: '', qualificacao: '', cep: '', observacao_rapida: '', 
                    nome_completo: '', rua: '', numero: '', bairro: '', cidade: '', 
                    prazo: '', urgencia: 'Média', descricao_caso: ''
                });
            }
            
            async function updateLead(docId, data) {
                await updateDoc(doc(db, 'leads', docId), data);
            }

            async function deleteLead(docId) {
                await deleteDoc(doc(db, 'leads', docId));
            }

            function renderLeadRow(doc) {
                const data = doc.data();
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50';
                tr.dataset.id = doc.id;
                const options = (arr, sel) => arr.map(f => `<option value="${f}" ${sel === f ? 'selected' : ''}>${f}</option>`).join('');
                tr.innerHTML = `
                    <td class="p-2 align-middle text-xs text-gray-500">${data.createdAt ? data.createdAt.toDate().toLocaleString('pt-BR') : '...'}</td>
                    <td class="p-2 align-middle"><input type="text" value="${data.contato || ''}" data-field="contato" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-md" placeholder="Contato"></td>
                    <td class="p-2 align-middle"><select data-field="fonte" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-md"><option value="" disabled ${!data.fonte ? 'selected' : ''}>Selecione</option>${options(fontesDinamicas, data.fonte)}</select></td>
                    <td class="p-2 align-middle"><select data-field="qualificacao" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-md status-select"><option value="" disabled ${!data.qualificacao ? 'selected' : ''}>Selecione</option>${options(qualificacoesDinamicas, data.qualificacao)}</select></td>
                    <td class="p-2 align-middle"><input type="text" value="${data.cep || ''}" data-field="cep" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-md" placeholder="CEP"></td>
                    <td class="p-2 align-middle"><input type="text" value="${data.observacao_rapida || ''}" data-field="observacao_rapida" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-md" placeholder="Nota rápida"></td>
                    <td class="p-2 text-center align-middle"><div class="flex justify-center gap-2"><button class="openCaseModalBtn text-blue-600 p-2" title="Formular Caso"><i class="fas fa-file-alt fa-lg"></i></button><button class="removeRowBtn text-red-500 p-2" title="Excluir"><i class="fas fa-trash-alt fa-lg"></i></button></div></td>`;
                tableBody.appendChild(tr);
            }
            
            // --- Lógica do Modal de Caso ---
            closeCaseModalBtn.addEventListener('click', () => caseModal.classList.add('hidden'));
            cancelCaseModalBtn.addEventListener('click', () => caseModal.classList.add('hidden'));
            saveCaseBtn.addEventListener('click', saveCaseData);

            async function openCaseModal(docId) {
                currentEditingDocId = docId;
                const docSnap = await getDoc(doc(db, 'leads', docId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('caseContato').textContent = data.contato || 'N/A';
                    document.getElementById('caseVendedor').textContent = data.vendedor || 'N/A';
                    document.getElementById('caseNomeCompleto').value = data.nome_completo || '';
                    document.getElementById('caseRua').value = data.rua || '';
                    document.getElementById('caseNumero').value = data.numero || '';
                    document.getElementById('caseBairro').value = data.bairro || '';
                    document.getElementById('caseCidade').value = data.cidade || '';
                    document.getElementById('casePrazo').value = data.prazo || '';
                    document.getElementById('caseUrgencia').value = data.urgencia || 'Média';
                    document.getElementById('caseTextArea').value = data.descricao_caso || '';
                    caseModal.classList.remove('hidden');
                }
            }
            
            async function saveCaseData() {
                if (!currentEditingDocId) return;
                const dataToSave = {
                    nome_completo: document.getElementById('caseNomeCompleto').value,
                    rua: document.getElementById('caseRua').value,
                    numero: document.getElementById('caseNumero').value,
                    bairro: document.getElementById('caseBairro').value,
                    cidade: document.getElementById('caseCidade').value,
                    prazo: document.getElementById('casePrazo').value,
                    urgencia: document.getElementById('caseUrgencia').value,
                    descricao_caso: document.getElementById('caseTextArea').value
                };
                await updateLead(currentEditingDocId, dataToSave);
                caseModal.classList.add('hidden');
                alert('Caso salvo com sucesso!');
            }
        });
    </script>
</body>
</html>