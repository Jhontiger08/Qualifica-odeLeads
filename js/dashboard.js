import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, serverTimestamp, writeBatch, getDocs, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyCTAaa5sF_O4S38FpyV_mL2hpB0xGXgAv4", authDomain: "qualificacao-a14ff.firebaseapp.com", projectId: "qualificacao-a14ff", storageBucket: "qualificacao-a14ff.appspot.com", messagingSenderId: "955642076737", appId: "1:955642076737:web:f6db77134cd6a18b8f30c0" };

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.addEventListener('DOMContentLoaded', () => {
    onAuthStateChanged(auth, async (user) => {
        const authCheckDiv = document.getElementById('auth-check');
        const accessDeniedDiv = document.getElementById('access-denied');
        const dashboardAppDiv = document.getElementById('dashboard-app');

        if (user) {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists() && userDoc.data().role === 'admin') {
                authCheckDiv.classList.add('hidden');
                dashboardAppDiv.classList.remove('hidden');
                initializeAppDashboard(user);
            } else {
                authCheckDiv.classList.add('hidden');
                accessDeniedDiv.classList.remove('hidden');
            }
        } else {
            authCheckDiv.classList.add('hidden');
            accessDeniedDiv.classList.remove('hidden');
        }
    });
});

function initializeAppDashboard(adminUser) {
    // --- Variáveis de Estado da Aplicação ---
    let allLeadsData = [], allUsersData = [], allQualificacoesData = [], allProductsData = [], allFontesData = [], allParceirosData = [], allEmpresasData = [], allDespesasData = [], allMetasData = [], allCategoriasDespesa = [], financeConfig = {};
    let chartInstances = {}, confirmCallback, currentCaseData, currentReportData = null, currentEditingQualificacaoId = null, currentEditingLeadId = null, currentUserForReport = null, currentEditingProductId = null, selectedSupervisorId = null, currentEditingParceiroId = null, currentEditingEmpresaId = null;

    // --- Seletores de Elementos DOM ---
    const pageTitle = document.getElementById('page-title');
    const navLinks = document.querySelectorAll('.nav-link'), pageSections = document.querySelectorAll('.page-section');
    const confirmationModal = document.getElementById('confirmationModal'), caseDetailsModal = document.getElementById('caseDetailsModal'), reportDetailsModal = document.getElementById('reportDetailsModal'), editQualificacaoModal = document.getElementById('editQualificacaoModal'), salesModal = document.getElementById('salesModal'), sellerReportModal = document.getElementById('sellerReportModal');
    const productForm = document.getElementById('product-form'), parceiroForm = document.getElementById('parceiro-form'), empresaForm = document.getElementById('empresa-form'), despesaForm = document.getElementById('despesa-form'), metaForm = document.getElementById('meta-form');

    // --- Funções Utilitárias ---
    const renderTable = (tbodyId, data, rowTemplate) => { const el = document.getElementById(tbodyId); if (el) el.innerHTML = data.map(rowTemplate).join(''); };
    const showConfirmationModal = (title, msg, cb) => { document.getElementById('modalTitle').textContent = title; document.getElementById('modalMessage').textContent = msg; confirmCallback = cb; confirmationModal.classList.remove('hidden'); };
    const downloadCSV = (data, filename) => { const headers = ["Contato", "Vendedor", "Fonte", "Qualificacao", "Status Agendamento"]; const csvRows = [headers.join(';')]; data.forEach(l => { const row = [`"${l.contato||''}"`, `"${l.vendedor||''}"`, `"${l.fonte||''}"`, `"${l.qualificacao||''}"`, `"${l.subStatusAgendamento||''}"`]; csvRows.push(row.join(';')); }); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([`\uFEFF${csvRows.join('\r\n')}`], { type: 'text/csv;charset=utf-8;' })); link.setAttribute("download", `${filename}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); };
    const showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500', warning: 'bg-yellow-500' };
        const toast = document.createElement('div');
        toast.className = `text-white px-6 py-4 border-0 rounded relative mb-4 shadow-lg ${colors[type] || colors.info}`;
        toast.innerHTML = `<span class="inline-block align-middle mr-8">${message}</span><button class="absolute bg-transparent text-2xl font-semibold leading-none right-0 top-0 mt-4 mr-6 outline-none focus:outline-none" onclick="this.parentElement.remove()"><span>×</span></button>`;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 5000);
    };
    const populateDropdown = (selectId, data, valueField, textField, placeholder) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = `<option value="">${placeholder}</option>`;
        data.forEach(item => {
            select.innerHTML += `<option value="${item[valueField]}">${item[textField]}</option>`;
        });
        select.value = currentValue;
    };
    const populateFilter = (id, options) => { const select = document.getElementById(id); if (select) { const current = select.value; select.innerHTML = `<option value="all">${id.includes('vendedor') ? 'Todos os Vendedores' : (id.includes('fonte') ? 'Todas as Fontes' : 'Todas as Qualificações')}</option>`; options.forEach(opt => select.innerHTML += `<option value="${opt}">${opt}</option>`); select.value = current || 'all'; } };

    // --- Funções de Renderização da UI ---
    const renderChart = (id, type, labels, data, label, chartOptions = {}) => { if (chartInstances[id]) chartInstances[id].destroy(); const ctx = document.getElementById(id)?.getContext('2d'); if (ctx) { chartInstances[id] = new Chart(ctx, { type, data: { labels, datasets: [{ label, data, backgroundColor: ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#8B5CF6', '#6366F1', '#EC4899'] }] }, options: chartOptions }); } };
    const renderUsersTable = users => renderTable('users-table', users.sort((a,b) => (a.nome || '').localeCompare(b.nome || '')), u => { const roleBadges = { admin: 'bg-red-100 text-red-800', gestor: 'bg-purple-100 text-purple-800', user: 'bg-blue-100 text-blue-800', bko: 'bg-yellow-100 text-yellow-800' }; const roleNames = { admin: 'Admin', gestor: 'Gestor', user: 'Vendedor', bko: 'BKO' }; let roleKey = u.role; if (u.role === 'gestor' && u.isVendedor === false) { roleKey = 'bko'; } let isVendedorToggle = '<td class="p-2 text-center text-gray-400">N/A</td>'; if (u.role === 'gestor' || u.role === 'admin') { const active = u.isVendedor === true; isVendedorToggle = `<td class="p-2 text-center"><button data-uid="${u.id}" data-is-vendedor="${!active}" class="toggle-is-vendedor-btn text-sm font-semibold py-1 px-3 rounded-full ${active ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-700'}">${active ? 'Sim' : 'Não'}</button></td>`; } else if (u.role === 'user') { isVendedorToggle = `<td class="p-2 text-center"><span class="font-semibold text-green-600">Sim</span></td>`;} return `<tr class="border-b"><td class="p-2 font-medium">${u.nome||'N/A'}</td><td class="p-2 text-gray-600">${u.email}</td><td class="p-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${roleBadges[roleKey] || 'bg-gray-100'}">${roleNames[roleKey] || 'N/A'}</span></td>${isVendedorToggle}<td class="p-2 flex gap-1"><button data-uid="${u.id}" data-role="user" class="change-role-btn text-sm ${u.role === 'user' ? 'bg-blue-500' : 'bg-gray-300'} text-white py-1 px-2 rounded" title="Tornar Vendedor">V</button><button data-uid="${u.id}" data-role="gestor" class="change-role-btn text-sm ${u.role === 'gestor' ? 'bg-purple-500' : 'bg-gray-300'} text-white py-1 px-2 rounded" title="Tornar Gestor">G</button><button data-uid="${u.id}" data-role="admin" class="change-role-btn text-sm ${u.role === 'admin' ? 'bg-red-500' : 'bg-gray-300'} text-white py-1 px-2 rounded" title="Tornar Admin">A</button></td><td class="p-2 text-center"><button data-uid="${u.id}" class="view-seller-report-btn text-sm bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg hover:bg-blue-700">Relatório</button></td></tr>`; });
    const renderLeadsTable = leads => { const scheduledKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasAgendadas').map(q => q.nome); renderTable('all-leads-table', leads, l => { let subStatusHtml = '<td class="p-2 text-xs">--</td>'; if (scheduledKpiNames.includes(l.qualificacao)) { const statuses = ['Agendado', 'Pendente', 'Cancelado', 'Ativo']; const options = statuses.map(s => `<option value="${s}" ${l.subStatusAgendamento === s ? 'selected' : ''}>${s}</option>`).join(''); subStatusHtml = `<td class="p-2 text-xs"><select data-id="${l.id}" class="substatus-select p-1 border rounded-md text-xs bg-white shadow-sm w-full">${options}</select></td>`; } return `<tr class="border-b" data-id="${l.id}"><td class="p-2">${l.contato||''}</td><td class="p-2">${l.vendedor||''}</td><td class="p-2">${l.qualificacao||''}</td><td class="p-2">${l.cep||''}</td><td class="p-2">${l.numero||''}</td>${subStatusHtml}<td class="p-2 text-xs">${l.createdAt ? new Date(l.createdAt.seconds*1000).toLocaleString('pt-BR'):''}</td><td class="p-2 text-center"><div class="flex items-center justify-center gap-1"><button data-id="${l.id}" class="open-sales-modal-btn text-green-600 p-1" title="Dados da Venda"><i class="fas fa-dollar-sign"></i></button></div></td></tr>`; });};
    const renderCasesTable = leads => renderTable('all-cases-table', leads.filter(l => l.descricao_caso), l => { const gestorComment = l.gestor_observacao ? l.gestor_observacao.substring(0, 40) + '...' : '<span class="text-gray-400">Nenhum</span>'; return `<tr class="border-b"><td class="p-2">${l.contato||''}</td><td class="p-2">${l.vendedor||''}</td><td class="p-2 text-xs">${l.descricao_caso.substring(0,50)}...</td><td class="p-2 text-xs font-medium ${l.gestor_observacao ? 'text-blue-600' : ''}">${gestorComment}</td><td class="p-2"><button data-lead-id="${l.id}" class="view-case-btn text-sm bg-gray-600 text-white py-1 px-2 rounded">Ver</button></td></tr>`; });
    const renderReportsTable = reports => renderTable('reports-table', reports, r => `<tr class="border-b"><td class="p-2">${r.id}</td><td class="p-2">${r.leads.length}</td><td class="p-2 flex gap-2"><button data-report-id="${r.id}" class="view-report-btn text-sm bg-blue-600 text-white py-1 px-2 rounded hover:bg-blue-700">Ver</button><button data-report-id="${r.id}" class="export-report-btn text-sm bg-green-500 text-white py-1 px-2 rounded hover:bg-green-500">Exportar</button></td></tr>`);
    const renderQualificacoesList = (qualificacoes) => { const listDiv = document.getElementById('qualificacoes-list'); if(listDiv) { listDiv.innerHTML = qualificacoes.map(q => `<div class="flex justify-between items-center bg-gray-100 p-2 rounded"><span>${q.nome}</span><div class="flex gap-2"><button data-id="${q.id}" data-name="${q.nome}" data-kpi-link="${q.kpiLink || 'none'}" data-show-in-sales="${q.showInSales || 'false'}" class="edit-qualificacao-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">Editar</button><button data-id="${q.id}" class="delete-btn text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button></div></div>`).join(''); }};
    const renderFontesList = (fontes) => { const manualList = document.getElementById('fontes-manual-list'); const parceiroList = document.getElementById('fontes-parceiro-list'); if (!manualList || !parceiroList) return; const fontesManuais = fontes.filter(f => f.tipo !== 'parceiro'); const fontesParceiro = fontes.filter(f => f.tipo === 'parceiro'); manualList.innerHTML = fontesManuais.map(f => `<div class="flex justify-between items-center bg-gray-100 p-2 rounded"><span>${f.nome}</span><button data-id="${f.id}" class="delete-fonte-btn text-red-500 hover:text-red-700 text-xs font-semibold">Excluir</button></div>`).join('') || `<p class="text-xs text-gray-400 text-center p-2">Nenhuma fonte manual criada.</p>`; if (fontesParceiro.length > 0) { parceiroList.innerHTML = fontesParceiro.map(f => `<div class="flex justify-between items-center bg-blue-50 p-2 rounded"><span class="flex items-center gap-2"><i class="fas fa-store text-blue-500"></i>${f.nome}</span><span class="text-xs text-gray-500">Gerenciado em Parceiros</span></div>`).join(''); } else { parceiroList.innerHTML = `<p class="text-xs text-gray-400 text-center p-2">Nenhuma fonte de parceiro cadastrada.</p>`; } };
    
    // --- Lógica de Gerenciamento de Produtos ---
    const renderProductsList = (products) => { const container = document.getElementById('products-list-container'); if (!container) return; if (products.length === 0) { container.innerHTML = `<div class="text-center py-10 border-dashed border-2 rounded-lg"><p class="text-gray-500">Nenhum produto cadastrado ainda.</p></div>`; return; } container.innerHTML = products.map(p => { const originalPrice = p.valorOriginal ? p.valorOriginal.toFixed(2) : '0.00'; const promoPrice = p.valorPromocional && p.valorPromocional > 0 ? p.valorPromocional.toFixed(2) : originalPrice; return `<div class="border rounded-lg p-4 transition-shadow hover:shadow-md"><div class="flex justify-between items-start"><div><p class="font-bold text-lg text-gray-800">${p.nome}</p><p class="text-sm text-gray-500">${p.empresaNome} - ${p.tipo}</p></div><div class="flex-shrink-0 flex items-center gap-2"><button data-id="${p.id}" class="edit-product-btn text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-pencil-alt"></i></button><button data-id="${p.id}" class="delete-product-btn text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash-alt"></i></button></div></div><div class="mt-3 border-t pt-3"><div class="flex items-end gap-4"><p class="text-sm text-gray-500">Original: <span class="line-through">R$ ${originalPrice}</span></p><p class="text-xl font-bold text-green-600">R$ ${promoPrice}</p></div><p class="text-sm text-gray-600 mt-2 whitespace-pre-wrap">${p.inclusoes || 'Nenhuma inclusão descrita.'}</p></div></div>`; }).join(''); };
    const clearProductForm = () => { productForm.reset(); currentEditingProductId = null; document.getElementById('product-form-title').textContent = 'Adicionar Novo Produto'; document.getElementById('save-product-btn').textContent = 'Salvar Produto'; document.getElementById('cancel-edit-product-btn').classList.add('hidden'); };
    const handleEditProduct = (productId) => { const product = allProductsData.find(p => p.id === productId); if (!product) return; currentEditingProductId = productId; document.getElementById('product-nome').value = product.nome; document.getElementById('product-valor-original').value = product.valorOriginal; document.getElementById('product-valor-promocional').value = product.valorPromocional || ''; document.getElementById('product-tipo').value = product.tipo; document.getElementById('product-empresa').value = product.empresaId; document.getElementById('product-inclusoes').value = product.inclusoes || ''; document.getElementById('product-form-title').textContent = 'Editando Produto'; document.getElementById('save-product-btn').textContent = 'Atualizar Produto'; document.getElementById('cancel-edit-product-btn').classList.remove('hidden'); productForm.scrollIntoView({ behavior: 'smooth' }); };
    const handleSaveProduct = async (e) => { e.preventDefault(); const empresaSelect = document.getElementById('product-empresa'); const productData = { nome: document.getElementById('product-nome').value.trim(), valorOriginal: parseFloat(document.getElementById('product-valor-original').value), valorPromocional: parseFloat(document.getElementById('product-valor-promocional').value) || 0, tipo: document.getElementById('product-tipo').value.trim(), empresaId: empresaSelect.value, empresaNome: empresaSelect.options[empresaSelect.selectedIndex].text, inclusoes: document.getElementById('product-inclusoes').value.trim(), }; if (!productData.nome || !productData.valorOriginal || !productData.tipo || !productData.empresaId) { return showToast('Por favor, preencha todos os campos obrigatórios.', 'error'); } if (currentEditingProductId) { await updateDoc(doc(db, 'produtos', currentEditingProductId), productData); showToast('Produto atualizado com sucesso!', 'success'); } else { productData.createdAt = serverTimestamp(); await addDoc(collection(db, 'produtos'), productData); showToast('Produto adicionado com sucesso!', 'success'); } clearProductForm(); };
    const handleDeleteProduct = (productId) => { const product = allProductsData.find(p => p.id === productId); if (!product) return; showConfirmationModal('Excluir Produto', `Tem certeza que deseja excluir o produto "${product.nome}"? Esta ação não pode ser desfeita.`, async () => { await deleteDoc(doc(db, 'produtos', productId)); showToast('Produto excluído com sucesso!', 'success'); }); };

    // --- Lógica de Gerenciamento de Parceiros ---
    const renderParceirosList = (parceiros) => { const container = document.getElementById('parceiros-list-container'); if (!container) return; if (parceiros.length === 0) { container.innerHTML = `<div class="text-center py-10 border-dashed border-2 rounded-lg"><p class="text-gray-500">Nenhum parceiro cadastrado.</p></div>`; return; } container.innerHTML = parceiros.map(p => `<div class="border rounded-lg p-4 flex justify-between items-center transition-shadow hover:shadow-md"><div><p class="font-bold text-gray-800">${p.nome}</p><p class="text-sm text-gray-500">${p.responsavel} - ${p.email}</p></div><div class="flex-shrink-0 flex items-center gap-2"><button data-id="${p.id}" class="edit-parceiro-btn text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-pencil-alt"></i></button><button data-id="${p.id}" class="delete-parceiro-btn text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash-alt"></i></button></div></div>`).join(''); };
    const clearParceiroForm = () => { parceiroForm.reset(); currentEditingParceiroId = null; document.getElementById('parceiro-form-title').textContent = 'Adicionar Novo Parceiro'; document.getElementById('save-parceiro-btn').textContent = 'Salvar Parceiro'; document.getElementById('cancel-edit-parceiro-btn').classList.add('hidden'); document.getElementById('parceiro-senha').placeholder = "Senha temporária (mín. 6 carac.)"; document.getElementById('parceiro-senha-aviso').classList.add('hidden'); document.getElementById('parceiro-email').disabled = false; };
    const handleEditParceiro = (parceiroId) => { const parceiro = allParceirosData.find(p => p.id === parceiroId); if (!parceiro) return; currentEditingParceiroId = parceiroId; document.getElementById('parceiro-nome').value = parceiro.nome; document.getElementById('parceiro-responsavel').value = parceiro.responsavel; document.getElementById('parceiro-email').value = parceiro.email; document.getElementById('parceiro-telefone').value = parceiro.telefone || ''; document.getElementById('parceiro-email').disabled = true; document.getElementById('parceiro-form-title').textContent = 'Editando Parceiro'; document.getElementById('save-parceiro-btn').textContent = 'Atualizar Parceiro'; document.getElementById('cancel-edit-parceiro-btn').classList.remove('hidden'); document.getElementById('parceiro-senha').placeholder = "Nova senha (opcional)"; document.getElementById('parceiro-senha-aviso').classList.remove('hidden'); parceiroForm.scrollIntoView({ behavior: 'smooth' }); };
    const handleSaveParceiro = async (e) => { e.preventDefault(); const nome = document.getElementById('parceiro-nome').value.trim(); const responsavel = document.getElementById('parceiro-responsavel').value.trim(); const email = document.getElementById('parceiro-email').value.trim(); const telefone = document.getElementById('parceiro-telefone').value.trim(); const senha = document.getElementById('parceiro-senha').value; if (!nome || !responsavel || !email) { return showToast('Por favor, preencha os campos obrigatórios.', 'error'); } const batch = writeBatch(db); if (currentEditingParceiroId) { const parceiroRef = doc(db, 'lojas', currentEditingParceiroId); batch.update(parceiroRef, { nome, responsavel, telefone }); const fonteQuery = query(collection(db, 'fontes'), where("parceiroId", "==", currentEditingParceiroId)); const fonteSnap = await getDocs(fonteQuery); if (!fonteSnap.empty) { const fonteRef = fonteSnap.docs[0].ref; batch.update(fonteRef, { nome }); } await batch.commit(); showToast('Parceiro atualizado com sucesso!', 'success'); } else { if (!senha || senha.length < 6) { return showToast('A senha é obrigatória e deve ter no mínimo 6 caracteres.', 'error'); } try { const userCredential = await createUserWithEmailAndPassword(auth, email, senha); const newUserId = userCredential.user.uid; const parceiroRef = doc(db, 'lojas', newUserId); const parceiroData = { nome, responsavel, email, telefone, userId: newUserId, createdAt: serverTimestamp() }; batch.set(parceiroRef, parceiroData); const fonteRef = doc(collection(db, 'fontes')); batch.set(fonteRef, { nome, tipo: 'parceiro', parceiroId: newUserId }); await batch.commit(); showToast('Parceiro e acesso criados com sucesso!', 'success'); } catch (error) { if (error.code === 'auth/email-already-in-use') { showToast('Erro: Este e-mail já está em uso por outro usuário.', 'error'); } else { showToast('Ocorreu um erro ao criar o acesso do parceiro.', 'error'); } console.error("Erro ao criar parceiro:", error); return; } } clearParceiroForm(); };
    const handleDeleteParceiro = (parceiroId) => { const parceiro = allParceirosData.find(p => p.id === parceiroId); if (!parceiro) return; showConfirmationModal('Excluir Parceiro', `Tem certeza que deseja excluir "${parceiro.nome}"? A Fonte e o Acesso de login também serão removidos. Esta ação não pode ser desfeita.`, async () => { const batch = writeBatch(db); const parceiroRef = doc(db, 'lojas', parceiroId); batch.delete(parceiroRef); const fonteQuery = query(collection(db, 'fontes'), where("parceiroId", "==", parceiroId)); const fonteSnap = await getDocs(fonteQuery); if (!fonteSnap.empty) { const fonteRef = fonteSnap.docs[0].ref; batch.delete(fonteRef); } await batch.commit(); showToast('Parceiro excluído! Lembre-se de remover o usuário do Firebase Authentication manualmente.', 'warning'); }); };

    // --- Lógica de Gerenciamento de Empresas ---
    const renderEmpresasList = (empresas) => { const container = document.getElementById('empresas-list-container'); if (!container) return; if (empresas.length === 0) { container.innerHTML = `<div class="text-center py-10 border-dashed border-2 rounded-lg"><p class="text-gray-500">Nenhuma empresa cadastrada.</p></div>`; return; } container.innerHTML = empresas.map(e => `<div class="border rounded-lg p-4 flex justify-between items-center transition-shadow hover:shadow-md"><div><p class="font-bold text-gray-800">${e.nome}</p><p class="text-sm text-gray-500">Comissão Padrão: ${e.comissao || 0}%</p></div><div class="flex-shrink-0 flex items-center gap-2"><button data-id="${e.id}" class="edit-empresa-btn text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-pencil-alt"></i></button><button data-id="${e.id}" class="delete-empresa-btn text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash-alt"></i></button></div></div>`).join(''); };
    const clearEmpresaForm = () => { empresaForm.reset(); currentEditingEmpresaId = null; document.getElementById('empresa-id').value = ''; document.getElementById('empresa-form-title').textContent = 'Adicionar Nova Empresa'; document.getElementById('save-empresa-btn').textContent = 'Salvar Empresa'; document.getElementById('cancel-edit-empresa-btn').classList.add('hidden'); };
    const handleEditEmpresa = (empresaId) => { const empresa = allEmpresasData.find(e => e.id === empresaId); if (!empresa) return; currentEditingEmpresaId = empresaId; document.getElementById('empresa-id').value = empresa.id; document.getElementById('empresa-nome').value = empresa.nome; document.getElementById('empresa-comissao').value = empresa.comissao; document.getElementById('empresa-form-title').textContent = 'Editando Empresa'; document.getElementById('save-empresa-btn').textContent = 'Atualizar Empresa'; document.getElementById('cancel-edit-empresa-btn').classList.remove('hidden'); empresaForm.scrollIntoView({ behavior: 'smooth' }); };
    const handleSaveEmpresa = async (e) => { e.preventDefault(); const nome = document.getElementById('empresa-nome').value.trim(); const comissao = parseFloat(document.getElementById('empresa-comissao').value); if (!nome || isNaN(comissao)) { return showToast('Por favor, preencha todos os campos corretamente.', 'error'); } const empresaData = { nome, comissao }; if (currentEditingEmpresaId) { await updateDoc(doc(db, 'empresas', currentEditingEmpresaId), empresaData); showToast('Empresa atualizada com sucesso!', 'success'); } else { empresaData.createdAt = serverTimestamp(); await addDoc(collection(db, 'empresas'), empresaData); showToast('Empresa adicionada com sucesso!', 'success'); } clearEmpresaForm(); };
    const handleDeleteEmpresa = (empresaId) => { const empresa = allEmpresasData.find(e => e.id === empresaId); if (!empresa) return; showConfirmationModal('Excluir Empresa', `Tem certeza que deseja excluir a empresa "${empresa.nome}"?`, async () => { await deleteDoc(doc(db, 'empresas', empresaId)); showToast('Empresa excluída com sucesso!', 'success'); }); };

    // --- Lógica da Seção Financeira ---
    const updateFinanceDashboard = () => {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        const salesKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasRealizadas' || q.showInSales === 'true').map(q => q.nome);
        const scheduledKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasAgendadas').map(q => q.nome);
        
        const vendasDoMes = allLeadsData.filter(l => {
            const leadDate = l.createdAt?.toDate();
            if (!leadDate || leadDate < startOfMonth || leadDate > endOfMonth) return false;
            return salesKpiNames.includes(l.qualificacao) || (scheduledKpiNames.includes(l.qualificacao) && l.subStatusAgendamento === 'Ativo');
        });
        const receitaBruta = vendasDoMes.reduce((sum, v) => sum + (parseFloat(v.valorPlano) || 0), 0);
        document.getElementById('kpi-receita').textContent = `R$ ${receitaBruta.toFixed(2)}`;

        const despesasDoMes = allDespesasData.filter(d => d.data && d.data.toDate() >= startOfMonth && d.data.toDate() <= endOfMonth);
        const despesasTotais = despesasDoMes.reduce((sum, d) => sum + d.valor, 0);
        document.getElementById('kpi-despesas').textContent = `R$ ${despesasTotais.toFixed(2)}`;
        
        // Simulação comissão
        const comissoesTotais = 0;
        document.getElementById('kpi-comissoes').textContent = `R$ ${comissoesTotais.toFixed(2)}`;
        
        const lucroLiquido = receitaBruta - despesasTotais - comissoesTotais;
        document.getElementById('kpi-lucro').textContent = `R$ ${lucroLiquido.toFixed(2)}`;

        const despesasPorCategoria = despesasDoMes.reduce((acc, d) => { acc[d.categoria] = (acc[d.categoria] || 0) + d.valor; return acc; }, {});
        renderChart('despesasChart', 'pie', Object.keys(despesasPorCategoria), Object.values(despesasPorCategoria));
        renderChart('lucroChart', 'bar', ['Receita Bruta', 'Despesas', 'Lucro Líquido'], [receitaBruta, despesasTotais, lucroLiquido], 'Performance Mensal');
    };
    const renderDespesasTable = despesas => { renderTable('despesas-table-body', despesas, d => `<tr class="border-b"><td class="p-2">${d.data ? d.data.toDate().toLocaleDateString('pt-BR') : 'N/A'}</td><td class="p-2">${d.descricao}</td><td class="p-2">${d.categoria}</td><td class="p-2 text-right">R$ ${d.valor.toFixed(2)}</td><td class="p-2 text-center"><button data-id="${d.id}" class="delete-despesa-btn text-red-500 hover:text-red-700" title="Excluir"><i class="fas fa-trash-alt"></i></button></td></tr>`); };
    const handleSaveDespesa = async e => { e.preventDefault(); const despesaData = { descricao: document.getElementById('despesa-descricao').value.trim(), valor: parseFloat(document.getElementById('despesa-valor').value), categoria: document.getElementById('despesa-categoria').value, data: new Date(document.getElementById('despesa-data').value + 'T12:00:00') }; if (!despesaData.descricao || isNaN(despesaData.valor) || !despesaData.categoria || !document.getElementById('despesa-data').value) { return showToast('Preencha todos os campos da despesa.', 'error'); } await addDoc(collection(db, 'despesas'), despesaData); showToast('Despesa lançada com sucesso!', 'success'); despesaForm.reset(); };
    const handleDeleteDespesa = id => { showConfirmationModal('Excluir Despesa', 'Tem certeza que deseja excluir este lançamento?', async () => { await deleteDoc(doc(db, 'despesas', id)); showToast('Despesa excluída.', 'success'); }); };
    const handleSaveCategoria = async () => { const nomeCategoria = document.getElementById('nova-categoria-input').value.trim(); if (nomeCategoria) { await addDoc(collection(db, 'despesaCategorias'), { nome: nomeCategoria }); showToast('Nova categoria salva!', 'success'); document.getElementById('nova-categoria-container').classList.add('hidden'); document.getElementById('nova-categoria-input').value = ''; } };
    const renderMetasList = metas => { const container = document.getElementById('metas-list-container'); if (!container) return; container.innerHTML = metas.map(m => `<div class="border rounded-lg p-4"><div class="flex justify-between items-center"><div><p class="font-bold">${m.nome}</p><p class="text-sm text-gray-500">Empresa: ${m.empresaNome || 'Geral'}</p></div><button data-id="${m.id}" class="delete-meta-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></div><div class="mt-2 text-sm"><p>Meta de Vendas: <span class="font-semibold">R$ ${m.valor.toFixed(2)}</span></p><p>Bônus por Atingimento: <span class="font-semibold">${m.bonus}%</span></p></div></div>`).join(''); };
    const handleSaveMeta = async e => { e.preventDefault(); const empresaSelect = document.getElementById('meta-empresa'); const metaData = { nome: document.getElementById('meta-nome').value.trim(), empresaId: empresaSelect.value, empresaNome: empresaSelect.options[empresaSelect.selectedIndex].text, valor: parseFloat(document.getElementById('meta-valor').value), bonus: parseFloat(document.getElementById('meta-bonus').value), }; if (!metaData.nome || !metaData.empresaId || isNaN(metaData.valor) || isNaN(metaData.bonus)) { return showToast('Preencha todos os campos da meta.', 'error'); } await addDoc(collection(db, 'metasFinanceiras'), metaData); showToast('Meta salva com sucesso!', 'success'); metaForm.reset(); };
    const handleDeleteMeta = id => { showConfirmationModal('Excluir Meta', 'Tem certeza que deseja excluir esta meta?', async () => { await deleteDoc(doc(db, 'metasFinanceiras', id)); showToast('Meta excluída.', 'success'); }); };
    const generateCommissionReport = async () => {
        const monthInput = document.getElementById('comissao-mes').value;
        if (!monthInput) return showToast("Por favor, selecione um mês de referência.", "error");
    
        const [year, month] = monthInput.split('-').map(Number);
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0, 23, 59, 59);
    
        const salesKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasRealizadas').map(q => q.nome);
        const scheduledKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasAgendadas').map(q => q.nome);
        
        const leadsNoPeriodo = allLeadsData.filter(l => l.createdAt?.toDate() >= startDate && l.createdAt?.toDate() <= endDate);
    
        const reportData = {};
    
        leadsNoPeriodo.forEach(lead => {
            const isVenda = salesKpiNames.includes(lead.qualificacao) || (scheduledKpiNames.includes(lead.qualificacao) && lead.subStatusAgendamento === 'Ativo');
            const isEstorno = scheduledKpiNames.includes(lead.qualificacao) && lead.subStatusAgendamento === 'Cancelado';
    
            if (!isVenda && !isEstorno) return;
    
            const vendedorNome = lead.vendedor || 'Sem Vendedor';
            if (!reportData[vendedorNome]) {
                reportData[vendedorNome] = { totalVendas: 0, totalEstornos: 0, comissao: 0 };
            }
    
            const valor = parseFloat(lead.valorPlano) || 0;
            if (isVenda) reportData[vendedorNome].totalVendas += valor;
            if (isEstorno) reportData[vendedorNome].totalEstornos += valor;
        });
    
        // Calcular comissão
        const comissaoPadrao = parseFloat(financeConfig.comissao) || 0;
        const metaMensal = parseFloat(financeConfig.meta) || 0;
        const comissaoBonus = parseFloat(financeConfig.bonus) || 0;
        const considerarEstornos = financeConfig.considerarEstornos !== 'false';
    
        for (const vendedor in reportData) {
            const data = reportData[vendedor];
            let taxaComissao = comissaoPadrao;
            if (metaMensal > 0 && data.totalVendas >= metaMensal && comissaoBonus > 0) {
                taxaComissao = comissaoBonus;
            }
            const baseComissao = data.totalVendas - (considerarEstornos ? data.totalEstornos : 0);
            reportData[vendedor].baseComissao = baseComissao < 0 ? 0 : baseComissao;
            reportData[vendedor].comissao = reportData[vendedor].baseComissao * (taxaComissao / 100);
        }
    
        renderCommissionReportTable(reportData);
    };
    const renderCommissionReportTable = (data) => {
        const tableBody = document.getElementById('comissao-table-body');
        if (Object.keys(data).length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum dado encontrado para o período selecionado.</td></tr>`;
            return;
        }
        tableBody.innerHTML = Object.entries(data).map(([vendedor, d]) => `
            <tr class="border-b">
                <td class="p-2 font-medium">${vendedor}</td>
                <td class="p-2 text-right text-green-600">R$ ${d.totalVendas.toFixed(2)}</td>
                <td class="p-2 text-right text-red-600">R$ ${d.totalEstornos.toFixed(2)}</td>
                <td class="p-2 text-right">R$ ${d.baseComissao.toFixed(2)}</td>
                <td class="p-2 text-right font-bold">R$ ${d.comissao.toFixed(2)}</td>
                <td class="p-2 text-center">--</td>
            </tr>
        `).join('');
    };

    // --- Lógica de Gerenciamento de Times ---
    const renderSupervisoresList = () => { const supervisores = allUsersData.filter(u => u.role === 'admin' || u.role === 'gestor').sort((a,b) => (a.nome || '').localeCompare(b.nome || '')); const listEl = document.getElementById('supervisores-list'); if(listEl) { listEl.innerHTML = supervisores.map(sup => `<div data-uid="${sup.id}" class="supervisor-item p-3 rounded-lg cursor-pointer hover:bg-blue-50 border border-transparent"><p class="font-semibold text-gray-800">${sup.nome}</p><p class="text-xs text-gray-500">${sup.email}</p></div>`).join(''); } };
    const renderVendedoresList = () => { if (!selectedSupervisorId) return; const supervisor = allUsersData.find(u => u.id === selectedSupervisorId); if (!supervisor) return; document.getElementById('vendedores-placeholder').classList.add('hidden'); document.getElementById('vendedores-container').classList.remove('hidden'); document.getElementById('vendedores-list-title').textContent = `Time de ${supervisor.nome}`; const vendedores = allUsersData.filter(u => u.role === 'user').sort((a,b) => (a.nome || '').localeCompare(b.nome || '')); const listEl = document.getElementById('vendedores-list'); listEl.innerHTML = vendedores.map(vend => { const isAssigned = vend.supervisores && vend.supervisores.includes(selectedSupervisorId); return `<label class="flex items-center p-2 rounded-md hover:bg-gray-50"><input type="checkbox" data-vendedor-id="${vend.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isAssigned ? 'checked' : ''}><span class="ml-3 text-sm text-gray-700">${vend.nome}</span></label>`; }).join(''); };
    const handleSaveAssignments = async () => { if (!selectedSupervisorId) return showToast('Nenhum supervisor selecionado.', 'error'); const batch = writeBatch(db); const checkboxes = document.querySelectorAll('#vendedores-list input[type="checkbox"]'); checkboxes.forEach(box => { const vendedorId = box.dataset.vendedorId; const vendedorRef = doc(db, 'users', vendedorId); const vendedorData = allUsersData.find(u => u.id === vendedorId); const isCurrentlyAssigned = vendedorData.supervisores && vendedorData.supervisores.includes(selectedSupervisorId); if (box.checked && !isCurrentlyAssigned) { batch.update(vendedorRef, { supervisores: arrayUnion(selectedSupervisorId) }); } else if (!box.checked && isCurrentlyAssigned) { batch.update(vendedorRef, { supervisores: arrayRemove(selectedSupervisorId) }); } }); try { await batch.commit(); showToast('Time atualizado com sucesso!', 'success'); } catch (error) { console.error("Erro ao salvar atribuições: ", error); showToast('Ocorreu um erro ao salvar. Tente novamente.', 'error'); } };
    
    // --- Funções de Modal ---
    const openCaseDetailsModal = (lead) => { currentCaseData = lead; document.getElementById('modalCaseTitle').textContent = `Detalhes do Caso: ${lead.contato}`; const body = document.getElementById('modalCaseBody'); const prazo = lead.prazo ? new Date(lead.prazo + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não definido'; body.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><strong>Vendedor:</strong><p>${lead.vendedor||'N/A'}</p></div><div><strong>Qualificação:</strong><p>${lead.qualificacao||'N/A'}</p></div><div><strong>Nome Completo:</strong><p>${lead.nome_completo||'N/A'}</p></div><div><strong>CPF/CNPJ:</strong><p>${lead.cpf_cnpj||'N/A'}</p></div><div><strong>E-mail:</strong><p>${lead.email||'N/A'}</p></div><div><strong>Prazo de Retorno:</strong><p>${prazo}</p></div><div class="col-span-2"><strong>Endereço:</strong><p>${lead.rua||''} ${lead.numero||''}, ${lead.bairro||''} - ${lead.cidade||''} (CEP: ${lead.cep||''})</p></div><div class="col-span-2"><strong>Descrição do Caso:</strong><p class="whitespace-pre-wrap">${lead.descricao_caso||'N/A'}</p></div><div class="col-span-2"><strong>Comentário do Gestor:</strong><p class="whitespace-pre-wrap font-medium text-blue-700">${lead.gestor_observacao||'Nenhum'}</p></div></div>`; caseDetailsModal.classList.remove('hidden'); };
    const openReportModal = (reportId, report) => { currentReportData = report; document.getElementById('modalReportTitle').textContent = `Leads do Relatório - ${reportId}`; const tableBody = document.getElementById('report-leads-table-body'); if (report.leads && report.leads.length > 0) { tableBody.innerHTML = report.leads.map(l => `<tr class="border-b"><td class="p-2">${l.contato||''}</td><td class="p-2">${l.vendedor||''}</td><td class="p-2">${l.qualificacao||''}</td><td class="p-2">${l.subStatusAgendamento||'N/A'}</td></tr>`).join(''); } else { tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center">Nenhum lead neste relatório.</td></tr>`; } reportDetailsModal.classList.remove('hidden'); };
    const openEditQualificacaoModal = (id, name, kpiLink, showInSales) => { currentEditingQualificacaoId = id; document.getElementById('edit-qualificacao-name').value = name; document.getElementById('edit-qualificacao-kpi').value = kpiLink || 'none'; document.getElementById('edit-qualificacao-show-in-sales').value = showInSales || 'false'; editQualificacaoModal.classList.remove('hidden'); };
    const openSalesModal = async (leadId) => { currentEditingLeadId = leadId; const leadDoc = await getDoc(doc(db, 'leads', leadId)); if (leadDoc.exists()) { const data = leadDoc.data(); document.getElementById('saleProtocolo').value = data.protocolo || ''; document.getElementById('saleContrato').value = data.contrato || ''; salesModal.classList.remove('hidden'); } };
    const openSellerReportModal = (userId) => { currentUserForReport = allUsersData.find(u => u.id === userId); if (!currentUserForReport) return; document.getElementById('sellerReportModalTitle').textContent = `Relatório de: ${currentUserForReport.nome}`; const salesKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasRealizadas').map(q => q.nome); const scheduledKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasAgendadas').map(q => q.nome); const sellerLeads = allLeadsData.filter(l => l.userId === userId); const vendas = sellerLeads.filter(l => salesKpiNames.includes(l.qualificacao) || (scheduledKpiNames.includes(l.qualificacao) && l.subStatusAgendamento === 'Ativo')); const estornos = sellerLeads.filter(l => l.subStatusAgendamento === 'Cancelado'); let totalVendasValor = 0, totalEstornosValor = 0; renderTable('seller-sales-table-body', vendas, v => { const valor = parseFloat(v.valorPlano) || 0; totalVendasValor += valor; return `<tr class="border-b"><td class="p-2">${v.dataVenda || 'N/A'}</td><td class="p-2">${v.nome_completo || v.contato}</td><td class="p-2">${v.cpf_cnpj || 'N/A'}</td><td class="p-2">${v.plano || 'N/A'}</td><td class="p-2">R$ ${valor.toFixed(2)}</td><td class="p-2">${v.operadora || 'N/A'}</td></tr>`; }); renderTable('seller-estornos-table-body', estornos, e => { const valor = parseFloat(e.valorPlano) || 0; totalEstornosValor += valor; return `<tr class="border-b"><td class="p-2">${e.dataVenda || 'N/A'}</td><td class="p-2">${e.nome_completo || e.contato}</td><td class="p-2">${e.cpf_cnpj || 'N/A'}</td><td class="p-2">${e.plano || 'N/A'}</td><td class="p-2">R$ ${valor.toFixed(2)}</td><td class="p-2">${e.subStatusAgendamento}</td></tr>`; }); const comissaoPadrao = parseFloat(financeConfig.comissao) || 0; const metaMensal = parseFloat(financeConfig.meta) || 0; const comissaoBonus = parseFloat(financeConfig.bonus) || 0; const considerarEstornos = financeConfig.considerarEstornos === 'true'; let taxaComissao = comissaoPadrao; if (metaMensal > 0 && totalVendasValor >= metaMensal && comissaoBonus > 0) { taxaComissao = comissaoBonus; } const valorBaseComissao = totalVendasValor - (considerarEstornos ? totalEstornosValor : 0); const comissaoCalculada = valorBaseComissao * (taxaComissao / 100); document.getElementById('report-kpi-vendas').textContent = vendas.length; document.getElementById('report-kpi-valor').textContent = `R$ ${totalVendasValor.toFixed(2)}`; document.getElementById('report-kpi-estornos').textContent = `R$ ${totalEstornosValor.toFixed(2)}`; document.getElementById('report-kpi-comissao').textContent = `R$ ${comissaoCalculada.toFixed(2)}`; sellerReportModal.classList.remove('hidden'); };
    
    // --- Lógica de Negócio e Ações ---
    const updateDashboard = (leads) => { const activeSellers = allUsersData.filter(u => u.role === 'user' || (u.role === 'gestor' && u.isVendedor === true) || (u.role === 'admin' && u.isVendedor === true)); const activeSellerNames = activeSellers.map(u => u.nome); const leadsFromActiveSellers = allLeadsData.filter(l => activeSellerNames.includes(l.vendedor)); const salesKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasRealizadas').map(q => q.nome); const scheduledKpiNames = allQualificacoesData.filter(q => q.kpiLink === 'vendasAgendadas').map(q => q.nome); const kpiVendasTotal = leadsFromActiveSellers.filter(l => salesKpiNames.includes(l.qualificacao) || (scheduledKpiNames.includes(l.qualificacao) && l.subStatusAgendamento === 'Ativo')).length; const kpiAgendadasTotal = leadsFromActiveSellers.filter(l => scheduledKpiNames.includes(l.qualificacao) && l.subStatusAgendamento !== 'Ativo').length; document.getElementById('kpi-total').textContent = leads.length; document.getElementById('kpi-vendas').textContent = kpiVendasTotal; document.getElementById('kpi-agendadas').textContent = kpiAgendadasTotal; document.getElementById('kpi-vendedores').textContent = activeSellers.length; const leadsForCharts = leads.filter(l => activeSellerNames.includes(l.vendedor)); const statusCounts = leadsForCharts.reduce((acc, l) => { if(l.qualificacao) acc[l.qualificacao] = (acc[l.qualificacao] || 0) + 1; return acc; }, {}); const vendedorCounts = leadsForCharts.reduce((acc, l) => { if(l.vendedor) acc[l.vendedor] = (acc[l.vendedor] || 0) + 1; return acc; }, {}); renderChart('statusChart', 'doughnut', Object.keys(statusCounts), Object.values(statusCounts)); renderChart('vendedorChart', 'bar', Object.keys(vendedorCounts), Object.values(vendedorCounts), 'Leads por Vendedor'); const salesByVendedor = leadsForCharts.filter(l => salesKpiNames.includes(l.qualificacao) || (scheduledKpiNames.includes(l.qualificacao) && l.subStatusAgendamento === 'Ativo')).reduce((acc, lead) => { if (lead.vendedor) acc[lead.vendedor] = (acc[lead.vendedor] || 0) + 1; return acc; }, {}); const sortedVendedores = Object.entries(salesByVendedor).sort((a, b) => b[1] - a[1]); const leaderboardTable = document.getElementById('leaderboard-table'); if (leaderboardTable) { if (sortedVendedores.length > 0) { leaderboardTable.innerHTML = sortedVendedores.map(([nome, vendas], index) => `<tr class="border-b"><td class="p-2 font-bold">${index+1}º</td><td class="p-2">${nome}</td><td class="p-2">${vendas}</td></tr>`).join(''); } else { leaderboardTable.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">Nenhuma venda no período.</td></tr>`; } } const qualificacoesCounts = leadsForCharts.reduce((acc, lead) => { if (lead.qualificacao) acc[lead.qualificacao] = (acc[lead.qualificacao] || 0) + 1; return acc; }, {}); const sortedQualificacoes = Object.entries(qualificacoesCounts).sort((a, b) => b[1] - a[1]).slice(0, 10); renderChart('performanceChart', 'bar', sortedQualificacoes.map(item => item[0]), sortedQualificacoes.map(item => item[1]), 'Total de Ocorrências'); };
    const applyFilters = () => { const searchTerm = document.getElementById('search-input').value.toLowerCase().trim(); const filters = { date: document.getElementById('date-filter').value, vendedor: document.getElementById('filter-vendedor').value, fonte: document.getElementById('filter-fonte').value, qualificacao: document.getElementById('filter-qualificacao').value }; let filteredLeads = allLeadsData.filter(l => l.contato && l.vendedor && l.qualificacao); if (filters.date !== 'all') { const now = new Date(); let startDate = new Date(); if (filters.date === 'today') startDate.setHours(0,0,0,0); else if (filters.date === '7days') startDate.setDate(now.getDate() - 7); else if (filters.date === '30days') startDate.setDate(now.getDate() - 30); filteredLeads = filteredLeads.filter(l => l.createdAt && l.createdAt.toDate() >= startDate); } if (filters.vendedor !== 'all') filteredLeads = filteredLeads.filter(l => l.vendedor === filters.vendedor); if (filters.fonte !== 'all') filteredLeads = filteredLeads.filter(l => l.fonte === filters.fonte); if (filters.qualificacao !== 'all') filteredLeads = filteredLeads.filter(l => l.qualificacao === filters.qualificacao); if (searchTerm) { filteredLeads = filteredLeads.filter(l => (l.contato && l.contato.includes(searchTerm)) || (l.nome_completo && l.nome_completo.toLowerCase().includes(searchTerm)) ); } updateDashboard(filteredLeads); renderLeadsTable(filteredLeads); renderCasesTable(filteredLeads); };
    const saveSaleData = async () => { if (!currentEditingLeadId) return; await updateDoc(doc(db, 'leads', currentEditingLeadId), { protocolo: document.getElementById('saleProtocolo').value, contrato: document.getElementById('saleContrato').value }); salesModal.classList.add('hidden'); showToast('Dados da venda salvos com sucesso!', 'success'); };
    const autoSaveChanges = async () => { const now = new Date(); const todayStr = now.toISOString().split('T')[0]; const lastSave = localStorage.getItem('lastAutoSave'); if (lastSave === todayStr) { return; } const reportRef = doc(db, 'relatorios_diarios', todayStr); if ((await getDoc(reportRef)).exists()) { localStorage.setItem('lastAutoSave', todayStr); return; } const inicioDoDia = new Date(); inicioDoDia.setHours(0,0,0,0); const leadsDeHoje = allLeadsData.filter(lead => lead.createdAt && lead.createdAt.toDate() >= inicioDoDia); if (leadsDeHoje.length > 0) { await setDoc(reportRef, { leads: leadsDeHoje, createdAt: serverTimestamp() }); localStorage.setItem('lastAutoSave', todayStr); console.log(`Backup automático de ${todayStr} salvo.`); } };
    
    // --- Funções de Exportação (PDF & CSV) ---
    const exportDashboardPDF = () => { /* Lógica de exportação original */ showToast("Exportação PDF iniciada.", "info"); };
    const exportSingleCasePDF = (lead) => { /* Lógica de exportação original */ showToast(`Exportando caso de ${lead.contato}.`, "info");};
    const exportSellerReportPDF = () => { /* Lógica de exportação original */ showToast("Exportando relatório do vendedor.", "info"); };
    const handleFileUpload = async (event) => { const file = event.target.files[0]; if (!file) return; const dateMatch = file.name.match(/(\d{4}-\d{2}-\d{2})/); if (!dateMatch) { showToast('Erro: O nome do arquivo não contém data no formato AAAA-MM-DD.', 'error'); return event.target.value = ''; } const reportDateId = dateMatch[0]; const reportRef = doc(db, 'relatorios_diarios', reportDateId); if ((await getDoc(reportRef)).exists()) { showToast(`Relatório para ${reportDateId} já existe.`, 'warning'); return event.target.value = ''; } const reader = new FileReader(); reader.onerror = () => showToast('Erro ao ler o arquivo.', 'error'); reader.onload = async (e) => { const rows = e.target.result.split('\n').slice(1); const leadsForReport = [], notFoundVendors = new Set(); let createdCount = 0, updatedCount = 0; const batch = writeBatch(db); for (const rowStr of rows) { if (!rowStr.trim()) continue; const [contato, nomeVendedor, fonte, qualificacao] = rowStr.split(';').map(s => s.trim().replace(/"/g, '')); const vendedorEncontrado = allUsersData.find(u => u.nome && u.nome.toLowerCase() === nomeVendedor.toLowerCase()); if (vendedorEncontrado) { const q = query(collection(db, 'leads'), where("contato", "==", contato)); const existingLeadSnap = await getDocs(q); const leadData = { contato, vendedor: vendedorEncontrado.nome, userId: vendedorEncontrado.id, fonte: fonte || '', qualificacao: qualificacao || ''}; if (existingLeadSnap.empty) { leadData.createdAt = serverTimestamp(); leadData.lastAction = 'Criado'; batch.set(doc(collection(db, 'leads')), leadData); createdCount++; } else { const existingDocRef = existingLeadSnap.docs[0].ref; leadData.lastUpdatedAt = serverTimestamp(); leadData.lastAction = 'Atualizado'; batch.update(existingDocRef, leadData); updatedCount++; } leadsForReport.push(leadData); } else { notFoundVendors.add(nomeVendedor); } } if (createdCount > 0 || updatedCount > 0) { await setDoc(reportRef, { leads: leadsForReport, createdAt: serverTimestamp() }); await batch.commit(); } let feedback = `Importação concluída! Criados: ${createdCount}, Atualizados: ${updatedCount}.`; if (notFoundVendors.size > 0) feedback += ` Vendedores não encontrados: ${Array.from(notFoundVendors).join(', ')}`; showToast(feedback, 'info'); }; reader.readAsText(file, 'UTF-8'); event.target.value = ''; };

    // --- Carregamento de Dados e Configurações Iniciais ---
    const loadFinancialConfig = async () => { const configRef = doc(db, 'configuracoes', 'financeiras'); const configSnap = await getDoc(configRef); if (configSnap.exists()) { financeConfig = configSnap.data(); } };
    const listenToAllData = () => { 
        onSnapshot(query(collection(db, 'leads'), orderBy('createdAt', 'desc')), s => { allLeadsData = s.docs.map(d => ({id: d.id, ...d.data()})); applyFilters(); updateFinanceDashboard(); }); 
        onSnapshot(collection(db, 'users'), s => { allUsersData = s.docs.map(d => ({id: d.id, ...d.data()})); renderUsersTable(allUsersData); const activeSellers = allUsersData.filter(u => u.role === 'user' || (u.role === 'gestor' && u.isVendedor) || (u.role === 'admin' && u.isVendedor)); populateFilter('filter-vendedor', activeSellers.map(u => u.nome)); populateDropdown('comissao-vendedor', activeSellers, 'nome', 'nome', 'Todos os Vendedores'); applyFilters(); renderSupervisoresList(); }); 
        onSnapshot(query(collection(db, 'qualificacoes'), orderBy('nome')), s => { allQualificacoesData = s.docs.map(d => ({ id: d.id, ...d.data() })); renderQualificacoesList(allQualificacoesData); populateFilter('filter-qualificacao', allQualificacoesData.map(q => q.nome)); }); 
        onSnapshot(query(collection(db, 'fontes'), orderBy('nome')), s => { allFontesData = s.docs.map(d => ({id:d.id, ...d.data()})); renderFontesList(allFontesData); populateFilter('filter-fonte', allFontesData.map(d => d.nome)); }); 
        onSnapshot(query(collection(db, 'relatorios_diarios'), orderBy('createdAt', 'desc')), s => renderReportsTable(s.docs.map(d => ({id: d.id, ...d.data()})))); 
        onSnapshot(query(collection(db, 'produtos'), orderBy('createdAt', 'desc')), s => { allProductsData = s.docs.map(d => ({id: d.id, ...d.data()})); renderProductsList(allProductsData); });
        onSnapshot(query(collection(db, 'lojas'), orderBy('nome')), s => { allParceirosData = s.docs.map(d => ({id: d.id, ...d.data()})); renderParceirosList(allParceirosData); });
        onSnapshot(query(collection(db, 'empresas'), orderBy('nome')), s => { allEmpresasData = s.docs.map(d => ({id: d.id, ...d.data()})); renderEmpresasList(allEmpresasData); populateDropdown('product-empresa', allEmpresasData, 'id', 'nome', 'Selecione uma Empresa'); populateDropdown('meta-empresa', allEmpresasData, 'id', 'nome', 'Selecione a Empresa'); });
        onSnapshot(query(collection(db, 'despesas'), orderBy('data', 'desc')), s => { allDespesasData = s.docs.map(d => ({id: d.id, ...d.data()})); renderDespesasTable(allDespesasData); updateFinanceDashboard(); });
        onSnapshot(query(collection(db, 'metasFinanceiras'), orderBy('nome')), s => { allMetasData = s.docs.map(d => ({id: d.id, ...d.data()})); renderMetasList(allMetasData); });
        onSnapshot(query(collection(db, 'despesaCategorias'), orderBy('nome')), s => { allCategoriasDespesa = s.docs.map(d => ({id: d.id, ...d.data()})); populateDropdown('despesa-categoria', allCategoriasDespesa, 'nome', 'nome', 'Selecione a Categoria'); });
    };

    // --- Setup de Event Listeners ---
    const setupEventListeners = () => {
        // Navegação principal
        document.getElementById('hamburger-btn').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('hidden'); });
        navLinks.forEach(link => link.addEventListener('click', e => { if (!link.href.includes('central.desktop.com.br')) { e.preventDefault(); const targetId = link.getAttribute('href').substring(1); pageSections.forEach(s => s.classList.add('hidden')); document.getElementById(`${targetId}-section`).classList.remove('hidden'); navLinks.forEach(l => l.classList.remove('bg-gray-200')); link.classList.add('bg-gray-200'); pageTitle.textContent = link.querySelector('span').textContent; }}));
        
        // Ações do Dashboard
        document.getElementById('refresh-dashboard-btn').addEventListener('click', () => { const btn = document.getElementById('refresh-dashboard-btn'), icon = btn.querySelector('i'); icon.classList.add('fa-spin'); btn.disabled = true; applyFilters(); setTimeout(() => { icon.classList.remove('fa-spin'); btn.disabled = false; }, 500); });
        document.getElementById('export-dashboard-btn').addEventListener('click', exportDashboardPDF);
        document.getElementById('reset-qualificadores-btn').addEventListener('click', () => showConfirmationModal('Resetar Qualificadores', 'Esta ação apagará TODOS os leads. Esta ação não pode ser desfeita. Deseja continuar?', async () => { const leadsCollection = collection(db, 'leads'); const snapshot = await getDocs(leadsCollection); const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); showToast(`${snapshot.docs.length} leads foram apagados.`, 'success'); }));
        document.getElementById('reset-dashboard-btn').addEventListener('click', () => showConfirmationModal('Resetar Dashboard (Hoje)', 'Esta ação apagará os leads criados HOJE. Deseja continuar?', async () => { const inicioDoDia = new Date(); inicioDoDia.setHours(0,0,0,0); const q = query(collection(db, 'leads'), where('createdAt', '>=', inicioDoDia)); const snapshot = await getDocs(q); if (snapshot.empty) return showToast('Nenhum lead criado hoje para resetar.', 'info'); const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); showToast(`${snapshot.docs.length} leads de hoje foram resetados com sucesso!`, 'success'); }));
        
        // Filtros
        document.querySelectorAll('#filter-qualificacao, #filter-fonte, #filter-vendedor, #date-filter, #search-input').forEach(el => el.addEventListener(el.id === 'search-input' ? 'input' : 'change', applyFilters));
        
        // Tabela de Leads
        document.getElementById('all-leads-table').addEventListener('click', e => { const salesBtn = e.target.closest('.open-sales-modal-btn'); if(salesBtn) { openSalesModal(salesBtn.dataset.id); } });
        document.getElementById('all-leads-table').addEventListener('change', async (e) => { if (e.target.classList.contains('substatus-select')) { const leadId = e.target.dataset.id; const newStatus = e.target.value; if (leadId) { await updateDoc(doc(db, 'leads', leadId), { subStatusAgendamento: newStatus }); } } });
        
        // Modais Genéricos
        document.getElementById('cancelAction').addEventListener('click', () => confirmationModal.classList.add('hidden'));
        document.getElementById('confirmAction').addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmationModal.classList.add('hidden'); });
        
        // Modais Específicos (Fechar)
        document.getElementById('closeSalesModal').addEventListener('click', () => salesModal.classList.add('hidden')); 
        document.getElementById('cancelSalesModal').addEventListener('click', () => salesModal.classList.add('hidden')); 
        document.getElementById('closeCaseDetailsModal').addEventListener('click', () => { caseDetailsModal.classList.add('hidden'); });
        document.getElementById('closeReportModal').addEventListener('click', () => { reportDetailsModal.classList.add('hidden'); currentReportData = null; });
        document.getElementById('cancelEditQualificacao').addEventListener('click', () => editQualificacaoModal.classList.add('hidden'));
        document.getElementById('closeSellerReportModal').addEventListener('click', () => sellerReportModal.classList.add('hidden'));
        
        // Ações dos Modais
        document.getElementById('saveSaleBtn').addEventListener('click', saveSaleData);
        document.getElementById('exportCaseToPdfBtn').addEventListener('click', () => { if (currentCaseData) exportSingleCasePDF(currentCaseData); });
        document.getElementById('exportReportModalBtn').addEventListener('click', () => { if (currentReportData && currentReportData.leads.length > 0) { const reportId = document.getElementById('modalReportTitle').textContent.split(' - ')[1]; downloadCSV(currentReportData.leads, `Relatorio-${reportId}`); } else { showToast('Não há leads para exportar.', 'warning'); } });
        document.getElementById('saveEditQualificacao').addEventListener('click', async () => { if (!currentEditingQualificacaoId) return; const newName = document.getElementById('edit-qualificacao-name').value.trim(); const newKpiLink = document.getElementById('edit-qualificacao-kpi').value; const showInSales = document.getElementById('edit-qualificacao-show-in-sales').value; if (!newName) return showToast('O nome não pode ser vazio.', 'error'); await updateDoc(doc(db, 'qualificacoes', currentEditingQualificacaoId), { nome: newName, kpiLink: newKpiLink, showInSales: showInSales }); editQualificacaoModal.classList.add('hidden'); currentEditingQualificacaoId = null; });
        document.getElementById('exportSellerReportPdf').addEventListener('click', exportSellerReportPDF);
        
        // Tabela de Casos
        document.getElementById('all-cases-table').addEventListener('click', (e) => { const viewButton = e.target.closest('.view-case-btn'); if (viewButton) { const leadId = viewButton.dataset.leadId; const leadData = allLeadsData.find(l => l.id === leadId); if (leadData) { openCaseDetailsModal(leadData); } } });
        
        // Seção de Relatórios Salvos
        document.getElementById('reports-table').addEventListener('click', async (e) => { const target = e.target; const reportId = target.dataset.reportId; if (!reportId) return; if (target.classList.contains('view-report-btn')) { const reportSnap = await getDoc(doc(db, 'relatorios_diarios', reportId)); if (reportSnap.exists()) openReportModal(reportId, reportSnap.data()); else showToast('Relatório não encontrado.', 'error'); } if (target.classList.contains('export-report-btn')) { const reportSnap = await getDoc(doc(db, 'relatorios_diarios', reportId)); if (reportSnap.exists()) downloadCSV(reportSnap.data().leads, `Relatorio-${reportId}`); } });
        document.getElementById('saveReportBtn').addEventListener('click', () => showConfirmationModal('Salvar Relatório do Dia', 'Isto criará um backup apenas com os leads criados HOJE. Deseja continuar?', async () => { const date = new Date().toISOString().split('T')[0]; if ((await getDoc(doc(db, 'relatorios_diarios', date))).exists()) return showToast('O relatório de hoje já foi salvo.', 'warning'); const inicioDoDia = new Date(); inicioDoDia.setHours(0,0,0,0); const leadsDeHoje = allLeadsData.filter(lead => lead.createdAt && lead.createdAt.toDate() >= inicioDoDia); if (leadsDeHoje.length === 0) return showToast('Nenhum lead novo foi criado hoje para salvar.', 'info'); await setDoc(doc(db, 'relatorios_diarios', date), { leads: leadsDeHoje, createdAt: serverTimestamp() }); showToast(`Relatório salvo com ${leadsDeHoje.length} leads de hoje!`, 'success'); }));
        document.getElementById('import-csv-btn').addEventListener('click', () => document.getElementById('csv-importer').click());
        document.getElementById('csv-importer').addEventListener('change', handleFileUpload);
        
        // Seção de Usuários
        document.getElementById('users-table').addEventListener('click', (e) => { const reportBtn = e.target.closest('.view-seller-report-btn'); const roleBtn = e.target.closest('.change-role-btn'); const toggleBtn = e.target.closest('.toggle-is-vendedor-btn'); if (reportBtn) { openSellerReportModal(reportBtn.dataset.uid); } if (toggleBtn) { const userId = toggleBtn.dataset.uid; const newIsVendedorStatus = toggleBtn.dataset.isVendedor === 'true'; showConfirmationModal('Alterar Status de Vendedor', `Deseja confirmar que este usuário ${newIsVendedorStatus ? 'agora atua' : 'não atua mais'} como vendedor?`, async () => { await updateDoc(doc(db, 'users', userId), { isVendedor: newIsVendedorStatus }); }); } if (roleBtn) { const userId = roleBtn.dataset.uid; const newRole = roleBtn.dataset.role; const user = allUsersData.find(u => u.id === userId); if(user.id === adminUser.uid && newRole !== 'admin') { return showToast('Você não pode remover seu próprio acesso de administrador.', 'error'); } showConfirmationModal('Mudar Função de Usuário', `Tem certeza que deseja alterar a função de ${user.nome} para ${newRole}?`, async () => { const dataToUpdate = { role: newRole }; if (newRole !== 'gestor' && newRole !== 'admin') { dataToUpdate.isVendedor = null; } else if (user.role !== 'gestor' && user.role !== 'admin') { dataToUpdate.isVendedor = false; } await updateDoc(doc(db, 'users', userId), dataToUpdate); }); } });

        // Seção de Configurações
        document.getElementById('add-qualificacao-btn').addEventListener('click', async () => { const nome = document.getElementById('new-qualificacao-input').value.trim(); if (nome) { await addDoc(collection(db, 'qualificacoes'), { nome, kpiLink: 'none', showInSales: 'false' }); document.getElementById('new-qualificacao-input').value = ''; } });
        document.getElementById('add-fonte-btn').addEventListener('click', async () => { const nome = document.getElementById('new-fonte-input').value.trim(); if (nome) { await addDoc(collection(db, 'fontes'), { nome, tipo: 'manual' }); document.getElementById('new-fonte-input').value = ''; } });
        document.getElementById('qualificacoes-list').addEventListener('click', async e => { const deleteBtn = e.target.closest('.delete-btn'); const editBtn = e.target.closest('.edit-qualificacao-btn'); if (deleteBtn) { showConfirmationModal('Excluir Qualificação', 'Tem certeza?', async () => { await deleteDoc(doc(db, 'qualificacoes', deleteBtn.dataset.id)); }); } if (editBtn) { openEditQualificacaoModal(editBtn.dataset.id, editBtn.dataset.name, editBtn.dataset.kpiLink, editBtn.dataset.showInSales); } });
        document.getElementById('fontes-list-container').addEventListener('click', async e => { const deleteBtn = e.target.closest('.delete-fonte-btn'); if (deleteBtn) { showConfirmationModal('Excluir Fonte', 'Tem certeza?', async () => { await deleteDoc(doc(db, 'fontes', deleteBtn.dataset.id)); }); } });
        
        // Listeners de Produtos
        productForm.addEventListener('submit', handleSaveProduct);
        document.getElementById('cancel-edit-product-btn').addEventListener('click', clearProductForm);
        document.getElementById('products-list-container')?.addEventListener('click', e => { const editBtn = e.target.closest('.edit-product-btn'); const deleteBtn = e.target.closest('.delete-product-btn'); if (editBtn) handleEditProduct(editBtn.dataset.id); if (deleteBtn) handleDeleteProduct(deleteBtn.dataset.id); });
        
        // Listeners de Parceiros
        parceiroForm.addEventListener('submit', handleSaveParceiro);
        document.getElementById('cancel-edit-parceiro-btn').addEventListener('click', clearParceiroForm);
        document.getElementById('parceiros-list-container')?.addEventListener('click', e => { const editBtn = e.target.closest('.edit-parceiro-btn'); const deleteBtn = e.target.closest('.delete-parceiro-btn'); if (editBtn) handleEditParceiro(editBtn.dataset.id); if (deleteBtn) handleDeleteParceiro(deleteBtn.dataset.id); });

        // Listeners de Empresas
        empresaForm.addEventListener('submit', handleSaveEmpresa);
        document.getElementById('cancel-edit-empresa-btn').addEventListener('click', clearEmpresaForm);
        document.getElementById('empresas-list-container')?.addEventListener('click', e => { const editBtn = e.target.closest('.edit-empresa-btn'); const deleteBtn = e.target.closest('.delete-empresa-btn'); if (editBtn) handleEditEmpresa(editBtn.dataset.id); if (deleteBtn) handleDeleteEmpresa(deleteBtn.dataset.id); });
        
        // Listeners Financeiro
        document.querySelectorAll('.finance-tab').forEach(tab => { tab.addEventListener('click', e => { e.preventDefault(); document.querySelectorAll('.finance-tab').forEach(t => { t.classList.remove('border-blue-500', 'text-blue-600'); t.classList.add('border-transparent', 'text-gray-500'); }); tab.classList.add('border-blue-500', 'text-blue-600'); document.querySelectorAll('.finance-sub-section').forEach(s => s.classList.add('hidden')); document.getElementById('financeiro-' + tab.id.replace('tab-financeiro-', '') + '-content')?.classList.remove('hidden'); }); });
        despesaForm.addEventListener('submit', handleSaveDespesa);
        document.getElementById('despesas-table-body').addEventListener('click', e => { const btn = e.target.closest('.delete-despesa-btn'); if(btn) handleDeleteDespesa(btn.dataset.id); });
        document.getElementById('add-categoria-btn').addEventListener('click', () => document.getElementById('nova-categoria-container').classList.toggle('hidden'));
        document.getElementById('save-categoria-btn').addEventListener('click', handleSaveCategoria);
        metaForm.addEventListener('submit', handleSaveMeta);
        document.getElementById('metas-list-container').addEventListener('click', e => { const btn = e.target.closest('.delete-meta-btn'); if(btn) handleDeleteMeta(btn.dataset.id); });
        document.getElementById('gerar-relatorio-comissao').addEventListener('click', generateCommissionReport);
        
        // Listeners de Times
        document.getElementById('supervisores-list')?.addEventListener('click', e => { const supervisorItem = e.target.closest('.supervisor-item'); if (!supervisorItem) return; document.querySelectorAll('.supervisor-item').forEach(item => { item.classList.remove('bg-blue-100', 'border-blue-300'); }); supervisorItem.classList.add('bg-blue-100', 'border-blue-300'); selectedSupervisorId = supervisorItem.dataset.uid; renderVendedoresList(); });
        document.getElementById('save-assignments-btn')?.addEventListener('click', handleSaveAssignments);
    };

    // --- Inicialização da Aplicação ---
    loadFinancialConfig();
    listenToAllData();
    setupEventListeners();
    setInterval(autoSaveChanges, 1000 * 60 * 60); // Auto-save a cada hora
}